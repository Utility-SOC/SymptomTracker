<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symptom Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- External Schema Loader -->
    <!-- This file is optional. If present, it sets window.EXTERNAL_SCHEMA to overwrite the embedded one. -->
    <script src="schemas/symptoms.js"></script>

    <style>
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .slide-enter-active,
        .slide-leave-active {
            transition: transform 0.3s ease;
        }

        .slide-enter-from {
            transform: translateX(100%);
        }

        .slide-leave-to {
            transform: translateX(-100%);
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3B82F6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3B82F6;
        }

        /* Loading State & Cloak */
        [v-cloak] {
            display: none !important;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            background: #f3f4f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
        }

        /* Hide Number Input Arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen">

    <!-- Loading Screen (Removed by Vue) -->
    <div id="loading-screen">
        <div class="text-4xl text-blue-500 mb-4"><i class="fas fa-circle-notch fa-spin"></i></div>
        <h2 class="text-xl font-bold text-gray-700">Loading App...</h2>
        <p class="text-sm text-gray-500 mt-2">Requires Internet Connection</p>
        <div id="loading-error" class="hidden mt-4 text-red-500 bg-red-100 p-3 rounded">
            <strong>Error:</strong> Dependencies failed to load.<br>Please check your internet connection.
        </div>
    </div>

    <!-- Script to check dependency loading -->
    <script>
        setTimeout(() => {
            if (typeof Vue === 'undefined') {
                document.getElementById('loading-error').classList.remove('hidden');
            }
        }, 5000);
    </script>

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-xl flex flex-col relative" v-cloak>

        <div v-if="!isAuthenticated"
            class="flex-1 flex flex-col justify-center items-center p-8 bg-gradient-to-br from-blue-50 to-white">
            <div class="bg-blue-600 text-white rounded-full w-20 h-20 flex items-center justify-center mb-6 shadow-lg">
                <i class="fas fa-heartbeat fa-3x"></i>
            </div>
            <h1 class="text-3xl font-bold mb-8 text-blue-800">Symptom Tracker</h1>

            <div v-if="authStep === 'name'" class="w-full">
                <p class="mb-4 text-gray-600 text-center">Hello! What is your name?</p>
                <input type="text" v-model="userNameInput" placeholder="Enter Name" @keyup.enter="lookupSessions"
                    class="w-full p-4 border-2 border-blue-100 rounded-xl text-center text-xl mb-6 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition">
                <button @click="lookupSessions" :disabled="!userNameInput.trim()"
                    class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg transform hover:-translate-y-0.5 transition disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            </div>

            <div v-if="authStep === 'session'" class="w-full">
                <p class="mb-4 text-gray-600 text-center">Welcome back, {{ userNameInput }}!</p>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Select
                        Session</label>
                    <select v-model="selectedSessionId"
                        class="w-full p-4 border-2 border-blue-100 rounded-xl bg-white outline-none">
                        <option :value="null">-- New Session --</option>
                        <option v-for="sess in availableSessions" :key="sess.id" :value="sess.id">
                            Started: {{ new Date(sess.created_at).toLocaleDateString() }}
                        </option>
                    </select>
                </div>

                <div class="flex flex-col gap-3">
                    <button @click="handleSessionStart"
                        class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg transform hover:-translate-y-0.5 transition">
                        {{ selectedSessionId ? 'Resume Session' : 'Start New Session' }}
                    </button>

                    <button @click="authStep = 'name'" class="text-gray-400 hover:text-gray-600 text-sm font-semibold">
                        Back to Name
                    </button>
                </div>
            </div>

            <button v-if="authStep === 'name'" @click="dangerClearAll"
                class="mt-12 text-red-300 text-xs hover:text-red-600 underline">
                Clear All Data
            </button>
        </div>

        <div v-else class="flex flex-col h-full">

            <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
                <h1 class="font-bold text-lg text-gray-700" v-if="currentStep === 1">Setup Session</h1>
                <h1 class="font-bold text-lg text-gray-700" v-else-if="currentStep === 2">Categories</h1>
                <h1 class="font-bold text-lg text-gray-700" v-else>Questions</h1>

                <div class="flex gap-4">
                    <button v-if="currentStep > 1" @click="resetToStart" class="text-gray-500 hover:text-blue-600"
                        title="Home">
                        <i class="fas fa-home fa-lg"></i>
                    </button>
                    <button @click="showHistory" class="text-gray-500 hover:text-blue-600" title="Export & History">
                        <i class="fas fa-file-export fa-lg"></i>
                    </button>
                    <button @click="logout" class="text-gray-400 hover:text-red-500" title="Logout">
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
            </header>

            <div v-if="showingHistory" class="absolute inset-0 bg-white z-50 flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h2 class="font-bold text-lg">Export Data</h2>
                    <button @click="showingHistory = false" class="text-gray-500 hover:text-gray-800"><i
                            class="fas fa-times fa-lg"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-6">
                        <h3 class="font-bold text-sm text-yellow-800 mb-2"><i class="fas fa-filter mr-1"></i> Filter
                            Export</h3>
                        <div class="flex gap-2">
                            <input type="date" v-model="exportStart" class="flex-1 border rounded p-2 text-sm">
                            <input type="date" v-model="exportEnd" class="flex-1 border rounded p-2 text-sm">
                        </div>
                    </div>
                    <div class="mb-8">
                        <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">Actions</h3>
                        <button @click="exportCSV"
                            class="w-full bg-indigo-600 text-white p-4 rounded-xl shadow mb-3 flex justify-between items-center hover:bg-indigo-700">
                            <span class="font-bold">Download CSV</span> <i class="fas fa-file-csv fa-lg"></i>
                        </button>
                        <button @click="exportMarkdown"
                            class="w-full bg-purple-600 text-white p-4 rounded-xl shadow mb-6 flex justify-between items-center hover:bg-purple-700">
                            <span class="font-bold">Export for AI</span> <i class="fas fa-robot fa-lg"></i>
                        </button>
                    </div>

                    <div class="border-t pt-4">
                        <h3 class="font-bold text-sm mb-2">Recent Entries</h3>
                        <div v-for="entry in recentHistory" :key="entry.id"
                            class="text-xs py-2 border-b text-gray-600 flex justify-between">
                            <span>{{ new Date(entry.timestamp).toLocaleDateString() }}</span>
                            <span class="truncate w-32 text-right">{{ getLabelFromId(entry.key) }}: {{entry.val}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentStep === 1" class="flex-1 p-6 flex flex-col justify-center space-y-4">

                <div class="text-center mb-2">
                    <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
                    <p class="text-gray-500">What are you logging today?</p>
                </div>

                <div class="bg-white p-4 rounded-xl border-2 border-gray-100 shadow-sm mb-2">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Date of
                        Record</label>
                    <input type="date" v-model="effectiveDate"
                        class="w-full text-lg font-bold text-gray-800 bg-transparent outline-none">
                </div>

                <button @click="selectContext('Acute')"
                    class="w-full bg-red-50 border-2 border-red-200 p-4 rounded-xl flex items-center justify-center gap-3 hover:bg-red-100 hover:border-red-400 transition group shadow-sm">
                    <div
                        class="bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-red-700 text-lg">Acute Incident</div>
                        <div class="text-xs text-red-500">Log sudden symptoms now</div>
                    </div>
                </button>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="selectContext('AM')"
                        class="p-6 rounded-xl border-2 hover:border-orange-400 hover:bg-orange-50 transition flex flex-col items-center gap-2 group">
                        <i class="fas fa-sun fa-2x text-orange-400 group-hover:scale-110 transition"></i>
                        <span class="font-bold text-gray-700">AM Check-in</span>
                    </button>

                    <button @click="selectContext('PM')"
                        class="p-6 rounded-xl border-2 hover:border-indigo-400 hover:bg-indigo-50 transition flex flex-col items-center gap-2 group">
                        <i class="fas fa-moon fa-2x text-indigo-400 group-hover:scale-110 transition"></i>
                        <span class="font-bold text-gray-700">PM Check-in</span>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="selectContext('Doctor')"
                        class="p-4 rounded-xl border-2 hover:border-blue-400 hover:bg-blue-50 transition flex flex-col items-center gap-2">
                        <i class="fas fa-user-md fa-lg text-blue-500"></i>
                        <span class="font-medium text-sm">For Doctor</span>
                    </button>
                    <button @click="selectContext('Research')"
                        class="p-4 rounded-xl border-2 hover:border-teal-400 hover:bg-teal-50 transition flex flex-col items-center gap-2">
                        <i class="fas fa-microscope fa-lg text-teal-500"></i>
                        <span class="font-medium text-sm">Research</span>
                    </button>
                </div>
            </div>

            <div v-if="currentStep === 2 && ['AM', 'PM', 'Acute'].includes(selectedContext)"
                class="flex-1 flex flex-col overflow-hidden">

                <div class="p-4 pb-2 border-b bg-white z-10">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold" :class="{'text-red-600': selectedContext === 'Acute'}">
                            <i v-if="selectedContext === 'Acute'" class="fas fa-exclamation-triangle mr-2"></i>
                            {{ selectedContext }} Session
                        </h2>
                        <span class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-500">{{ effectiveDate }}</span>
                    </div>

                    <!-- ACUTE TOGGLE -->
                    <div v-if="selectedContext === 'Acute'"
                        class="bg-red-50 p-2 rounded-lg flex items-center justify-between mb-1">
                        <span class="text-xs font-bold text-red-800 ml-1">
                            <i class="fas fa-clipboard-list mr-1"></i>
                            Full Survey Mode?
                        </span>
                        <div
                            class="relative inline-block w-10 mr-1 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="acute-toggle" v-model="acuteFullSurvey"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" />
                            <label for="acute-toggle"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-red-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <!-- PERIODIC TOGGLE -->
                    <div v-else class="bg-blue-50 p-2 rounded-lg flex items-center justify-between mb-1">
                        <span class="text-xs font-bold text-blue-800 ml-1">
                            <i class="fas fa-layer-group mr-1"></i>
                            Include Periodic Updates?
                        </span>
                        <div
                            class="relative inline-block w-10 mr-1 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="periodic-toggle" v-model="showPeriodic"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" />
                            <label for="periodic-toggle"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <p class="text-xs text-gray-400 mt-1" v-if="selectedContext === 'Acute' && !acuteFullSurvey">Quick
                        Mode: Answer single questions.</p>
                    <p class="text-xs text-red-500 mt-1" v-else-if="selectedContext === 'Acute'">Full Survey: Go through
                        all questions.</p>
                    <p class="text-xs text-gray-400 mt-1" v-else-if="!showPeriodic">Showing standard daily symptoms.</p>
                    <p class="text-xs text-blue-500 mt-1" v-else>Showing daily symptoms + health maintenance.</p>
                </div>

                <div class="flex-1 overflow-y-auto p-4 pb-32">
                    <div class="grid gap-3">
                        <div v-for="category in visibleCategories" :key="category.id" @click="enterCategory(category)"
                            class="bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center group"
                            :class="{'border-blue-300 bg-blue-50': category.isPeriodic}">
                            <div class="flex items-center gap-4">
                                <div class="relative w-12 h-12">
                                    <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                        <path class="text-gray-200"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none" stroke="currentColor" stroke-width="3" />
                                        <path :class="getPieColorClass(category.id)"
                                            :stroke-dasharray="getPieProgress(category.id) + ', 100'"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none" stroke="currentColor" stroke-width="3" />
                                    </svg>
                                    <div
                                        class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">
                                        {{ getCategoryCount(category.id) }}
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold text-gray-800">{{ category.label }}</h3>
                                    <p class="text-xs text-gray-400">{{ category.description }}</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                        </div>
                    </div>

                    <div class="mt-8 border-t-2 border-dashed pt-6">
                        <label class="block text-sm font-bold text-gray-600 mb-2">
                            <i class="fas fa-comment-medical mr-1"></i> Session Note / Summary
                        </label>
                        <textarea v-model="contextNote"
                            class="w-full border-2 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none h-24"
                            placeholder="Add overall notes for this session here..."></textarea>
                        <button @click="saveContextNote"
                            class="mt-2 w-full bg-gray-800 text-white p-3 rounded-lg font-bold text-sm hover:bg-gray-900 transition">
                            Save Note & Return Home
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentStep === 2 && ['Doctor', 'Research'].includes(selectedContext)"
                class="flex-1 p-6 flex flex-col">
                <h2 class="text-xl font-bold mb-4">Notes for {{ selectedContext }}</h2>
                <div class="bg-yellow-50 p-3 rounded mb-4 text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-2"></i> Log observations, questions to ask, or research details
                    here.
                </div>

                <textarea v-model="contextNote"
                    class="flex-1 w-full border-2 rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none resize-none mb-4"
                    placeholder="Start typing..."></textarea>

                <button @click="saveContextNote"
                    class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg">Save Note & Return
                    Home</button>
            </div>

            <div v-if="currentStep === 3" class="flex-1 flex flex-col p-6">
                <div class="w-full bg-gray-100 h-2 rounded-full mb-6">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                        :style="{ width: progressPercent + '%' }"></div>
                </div>

                <div class="flex-1 flex flex-col">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">{{ activeCategory.label }}</h3>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ activeQuestion.label }}</h2>

                    <div class="flex-1">

                        <div v-if="activeQuestion.input.type === 'likert'"
                            class="flex flex-col items-center justify-center space-y-4 py-4">

                            <div class="relative w-48 h-48 bg-gray-50 rounded-full border-4 border-blue-100 flex items-center justify-center shadow-inner cursor-ns-resize select-none touch-none"
                                @wheel.prevent="handleWheel" @touchstart="handleTouchStart"
                                @touchmove.prevent="handleTouchMove">

                                <div class="absolute top-4 text-gray-300 hover:text-blue-500 cursor-pointer"
                                    @click="adjustValue(1)">
                                    <i class="fas fa-chevron-up fa-2x"></i>
                                </div>

                                <div class="text-center z-10 pointer-events-none">
                                    <span class="text-6xl font-bold"
                                        :class="activeQuestion.input.useMankoski ? 'text-red-600' : 'text-blue-600'">
                                        {{ tempValue !== '' ? tempValue : 0 }}
                                    </span>

                                    <div v-if="!activeQuestion.input.useMankoski"
                                        class="text-xs font-bold text-gray-400 uppercase mt-1">
                                        Scale 0-10
                                    </div>
                                </div>

                                <div class="absolute bottom-4 text-gray-300 hover:text-blue-500 cursor-pointer"
                                    @click="adjustValue(-1)">
                                    <i class="fas fa-chevron-down fa-2x"></i>
                                </div>
                            </div>

                            <div v-if="activeQuestion.input.useMankoski" class="w-full px-4">
                                <div
                                    class="bg-red-50 border border-red-100 rounded-xl p-4 text-center transition-all duration-300">
                                    <p class="font-bold text-red-800 text-lg mb-1">Level {{ tempValue !== '' ? tempValue
                                        : 0 }}</p>
                                    <p class="text-sm text-red-700 leading-snug">
                                        {{ MANKOSKI_SCALE[tempValue !== '' ? tempValue : 0] }}
                                    </p>
                                </div>
                            </div>

                            <div v-if="activeQuestion.input.useMankoski" class="w-full px-4 mt-4">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Characteristics
                                    (Check all that apply)</label>
                                <div class="flex flex-wrap gap-2">
                                    <button
                                        v-for="tag in ['Sharp/Shooting', 'Dull/Aching', 'Numbness', 'In Motion', 'At Rest']"
                                        :key="tag" @click="toggleTag(tag)"
                                        class="px-3 py-2 rounded-lg text-sm font-bold border-2 transition-all"
                                        :class="selectedTags.includes(tag) ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-500 border-gray-200 hover:border-red-300'">
                                        {{ tag }}
                                        <i v-if="selectedTags.includes(tag)" class="fas fa-check ml-1 text-xs"></i>
                                    </button>
                                </div>
                            </div>

                            <div v-if="!activeQuestion.input.useMankoski"
                                class="flex justify-between w-full px-4 text-sm font-bold text-gray-500">
                                <span>{{ activeQuestion.input.low_label || 'None' }} (0)</span>
                                <span>{{ activeQuestion.input.high_label || 'Severe' }} (10)</span>
                            </div>
                        </div>

                        <div v-if="activeQuestion.input.type === 'select'" class="space-y-3">
                            <button v-for="opt in activeQuestion.input.options" :key="opt" @click="tempValue = opt"
                                :class="tempValue === opt ? 'bg-blue-600 text-white shadow-lg' : 'bg-white border-2 text-gray-600 hover:border-blue-300'"
                                class="w-full py-4 px-6 rounded-xl font-medium text-left transition flex justify-between items-center">
                                <span>{{ opt }}</span>
                                <i v-if="tempValue === opt" class="fas fa-check"></i>
                            </button>
                        </div>

                        <div v-if="activeQuestion.input.type === 'number'">
                            <input type="number" v-model="tempValue"
                                class="w-full p-6 text-4xl font-bold text-center border-2 rounded-xl focus:border-blue-500 outline-none">
                        </div>

                        <div v-if="activeQuestion.input.type === 'bp'"
                            class="flex items-center gap-2 justify-center py-8">
                            <div class="flex flex-col items-center">
                                <input type="number" v-model="bpSys" placeholder="120"
                                    class="w-32 p-4 text-3xl font-bold text-center border-2 rounded-xl focus:border-blue-500 outline-none">
                                <span class="text-xs text-gray-400 mt-1">SYS</span>
                            </div>
                            <span class="text-4xl text-gray-300">/</span>
                            <div class="flex flex-col items-center">
                                <input type="number" v-model="bpDia" placeholder="80"
                                    class="w-32 p-4 text-3xl font-bold text-center border-2 rounded-xl focus:border-blue-500 outline-none">
                                <span class="text-xs text-gray-400 mt-1">DIA</span>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label @click="showNoteField = !showNoteField"
                                class="text-sm text-blue-500 font-semibold cursor-pointer flex items-center gap-2">
                                <i class="fas fa-comment-alt"></i> {{ showNoteField ? 'Hide Note' : 'Add Note' }}
                            </label>
                            <textarea v-if="showNoteField" v-model="tempNote"
                                class="w-full border rounded-lg p-3 mt-2 h-24 focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="Details..."></textarea>
                        </div>

                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <button @click="prevQuestion"
                            class="text-gray-400 font-bold px-4 hover:text-gray-600">Back</button>

                        <div class="flex gap-2">
                            <button @click="skipQuestion"
                                class="bg-gray-200 text-gray-600 px-6 py-3 rounded-xl font-bold shadow hover:bg-gray-300 transition">
                                Skip
                            </button>

                            <button @click="nextQuestion"
                                :disabled="activeQuestion.input.type !== 'bp' && tempValue === '' && activeQuestion.input.type !== 'info' && activeQuestion.input.type !== 'likert'"
                                class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:-translate-y-0.5 transition">
                                {{ isLastQuestion ? 'Finish' : 'Next' }}
                            </button>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const MANKOSKI_SCALE = {
            0: "Pain free",
            1: "Very minor annoyance – occasional minor twinges. No medication needed.",
            2: "Minor annoyance – occasional strong twinges. No medication needed.",
            3: "Annoying enough to be distracting. Mild painkillers are effective.",
            4: "Can be ignored if really involved in work, but still distracting. Mild painkillers relieve for 3-4 hours.",
            5: "Can't be ignored for >30 mins. Mild painkillers reduce pain for 3-4 hours.",
            6: "Can't be ignored. Can still work/socialize. Stronger painkillers (codeine) reduce pain 3-4 hours.",
            7: "Difficulty concentrating, interferes with sleep. Function with effort. Stronger painkillers only partially effective.",
            8: "Physical activity severely limited. Read/converse with effort. Nausea/dizziness. Strongest painkillers reduce pain 3-4 hours.",
            9: "Unable to speak. Crying out or moaning uncontrollably – near delirium.",
            10: "Unconscious. Pain makes you pass out."
        };

        // --- NEW SCHEMA (Likert 0-10, BP Updated) ---
        const EMBEDDED_SCHEMA = [
            {
                "id": "strength",
                "label": "Strength",
                "description": "Standing, Walking, Arms, Dressing",
                "isPeriodic": false,
                "questions": [
                    { "id": "stand_chair", "label": "Standing from Chair", "input": { "type": "select", "options": ["Normal", "Use arms", "Rocking motion", "Assistance needed", "Unable"] } },
                    { "id": "stand_toilet", "label": "Standing from Toilet", "input": { "type": "select", "options": ["Normal", "Use arms", "Substitute motion", "Assistance needed"] } },
                    { "id": "arms_overhead", "label": "Arms Overhead (e.g. Wash Hair)", "input": { "type": "select", "options": ["Improved", "Same", "Slightly worse", "Much worse"] } },
                    { "id": "walking", "label": "Walking Ability", "input": { "type": "select", "options": ["Normal", "Normal (flat surface)", "Slow/Unsteady", "Device needed", "Unable"] } },
                    { "id": "dressing", "label": "Ability to Dress", "input": { "type": "select", "options": ["Normal", "Modified technique", "Assistance needed"] } }
                ]
            },
            {
                "id": "breathing",
                "label": "Breathing",
                "description": "Shortness of breath, Cough",
                "isPeriodic": false,
                "questions": [
                    { "id": "sob", "label": "Shortness of Breath", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Severe" } },
                    { "id": "cough", "label": "Cough Severity", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Severe" } }
                ]
            },
            {
                "id": "swallowing",
                "label": "Swallowing",
                "description": "Choking, Eating difficulty",
                "isPeriodic": false,
                "questions": [
                    { "id": "choking_events", "label": "Choking Incidents Today", "input": { "type": "number" } },
                    { "id": "solid_food", "label": "Difficulty with Solids", "input": { "type": "likert", "max": 10, "low_label": "Easy", "high_label": "Impossible" } }
                ]
            },
            {
                "id": "muscle",
                "label": "Muscle",
                "description": "Pain, Weakness",
                "isPeriodic": false,
                "questions": [
                    { "id": "muscle_pain", "label": "Muscle Pain", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Worst", "useMankoski": true } },
                    { "id": "overall_weakness", "label": "Overall Weakness", "input": { "type": "select", "options": ["Improved", "Same", "Slightly worse", "Much worse"] } }
                ]
            },
            {
                "id": "skin",
                "label": "Skin",
                "description": "Rashes, Itching, Calcinosis",
                "isPeriodic": false,
                "questions": [
                    { "id": "rash_severity", "label": "Rash Severity", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Severe" } },
                    { "id": "itch", "label": "Itching Level", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Intense" } },
                    { "id": "calcinosis", "label": "Calcinosis (Hard Lumps)", "input": { "type": "select", "options": ["None", "New lumps", "Existing painful", "Infected/Draining"] } },
                    { "id": "mechanics_hands", "label": "Mechanic's Hands", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Severe" } }
                ]
            },
            {
                "id": "joint",
                "label": "Joints",
                "description": "Pain, Stiffness",
                "isPeriodic": false,
                "questions": [
                    { "id": "joint_pain", "label": "Joint Pain", "input": { "type": "likert", "max": 10, "low_label": "None", "high_label": "Worst", "useMankoski": true } },
                    { "id": "stiffness", "label": "Morning Stiffness (min)", "input": { "type": "number" } }
                ]
            },
            {
                "id": "cognitive",
                "label": "Cognitive/Memory",
                "description": "Brain fog, Focus",
                "isPeriodic": false,
                "questions": [
                    { "id": "brain_fog", "label": "Brain Fog", "input": { "type": "likert", "max": 10, "low_label": "Clear", "high_label": "Foggy" } },
                    { "id": "memory", "label": "Memory Issues", "input": { "type": "select", "options": ["None", "Minor slips", "Noticeable", "Concerning"] } }
                ]
            },
            {
                "id": "maintenance",
                "label": "Health Maintenance",
                "description": "Vitals, Immunizations, Infections",
                "isPeriodic": true,
                "questions": [
                    { "id": "weight", "label": "Current Weight (lbs)", "input": { "type": "number" } },
                    { "id": "bp", "label": "Blood Pressure (mmHg)", "input": { "type": "bp" } },
                    { "id": "immunization", "label": "New Immunization?", "input": { "type": "select", "options": ["None", "Flu", "COVID", "Shingles", "Pneumonia", "Other"] } },
                    { "id": "infection", "label": "Current Infection?", "input": { "type": "select", "options": ["No", "UTI", "Respiratory", "Skin", "Other"] } },
                    { "id": "antibiotic", "label": "Taking Antibiotics?", "input": { "type": "select", "options": ["No", "Yes"] } }
                ]
            },
            {
                "id": "other",
                "label": "Other",
                "description": "Fatigue, Sleep, Fever",
                "isPeriodic": false,
                "questions": [
                    { "id": "fatigue", "label": "Fatigue Level", "input": { "type": "likert", "max": 10, "low_label": "Energetic", "high_label": "Exhausted" } },
                    { "id": "mood", "label": "Mood", "input": { "type": "likert", "max": 10, "low_label": "Low", "high_label": "Good" } },
                    { "id": "fever", "label": "Fever?", "input": { "type": "select", "options": ["No", "Suspected but not confirmed", "Yes (<100.4)", "Yes (>100.4)"] } }
                ]
            }
        ];

        createApp({
            setup() {

                // --- STATE ---
                // VERSION 2: Added 'sessions' table and 'session_id' to entries
                const db = new Dexie('HealthTrackerDB');
                db.version(1).stores({
                    entries: '++id, timestamp, effective_date, context, key'
                });
                db.version(2).stores({
                    sessions: '++id, user_name, created_at',
                    entries: '++id, session_id, timestamp, effective_date, context, key'
                });
                db.version(3).stores({
                    sessions: '++id, user_name, created_at',
                    entries: '++id, session_id, report_id, timestamp, effective_date, context, key'
                });

                // App Flow State
                const isAuthenticated = ref(false);
                const authStep = ref('name'); // 'name' | 'session'
                const userNameInput = ref('');
                const availableSessions = ref([]);
                const selectedSessionId = ref(null);
                const currentSessionId = ref(null);
                const currentReportId = ref(null); // Independent report context

                const currentStep = ref(1);
                const effectiveDate = ref(new Date().toISOString().split('T')[0]);
                const selectedContext = ref('');
                const contextNote = ref('');

                // Wizard State
                // Prioritize External Schema if loaded
                const initialSchema = (window.EXTERNAL_SCHEMA && window.EXTERNAL_SCHEMA.length > 0)
                    ? window.EXTERNAL_SCHEMA
                    : EMBEDDED_SCHEMA;

                const schema = ref(initialSchema);
                const activeCategory = ref(null);
                const activeQuestionIndex = ref(0);
                const tempValue = ref('');

                const tempNote = ref('');
                const showNoteField = ref(false);
                const returnAfterOne = ref(false); // Flag for gap filling mode

                // Acute State
                const acuteFullSurvey = ref(false);

                // Pain Tags State
                const selectedTags = ref([]);

                // BP State
                const bpSys = ref('');
                const bpDia = ref('');

                // Dashboard Filter
                const showPeriodic = ref(false);

                // Daily Progress Tracking
                const dailyCounts = ref({});
                const answeredKeys = ref(new Set());

                // History/Export State
                const showingHistory = ref(false);
                const exportStart = ref('');
                const exportEnd = ref('');
                const recentHistory = ref([]);

                // Session Config
                const SESSION_KEY = 'ht_session_expiry';
                const SESSION_ID_KEY = 'ht_session_id';
                const SESSION_DURATION = 7 * 24 * 60 * 60 * 1000;

                // --- COMPUTED ---
                const visibleCategories = computed(() => {
                    if (selectedContext.value === 'Acute') return schema.value;
                    return schema.value.filter(cat => {
                        if (cat.isPeriodic) return showPeriodic.value;
                        return true;
                    });
                });

                const activeQuestion = computed(() => {
                    if (!activeCategory.value) return null;
                    return activeCategory.value.questions[activeQuestionIndex.value];
                });

                const isLastQuestion = computed(() => {
                    if (!activeCategory.value) return false;
                    return activeQuestionIndex.value === activeCategory.value.questions.length - 1;
                });

                const progressPercent = computed(() => {
                    if (!activeCategory.value) return 0;
                    return ((activeQuestionIndex.value + 1) / activeCategory.value.questions.length) * 100;
                });

                // --- WATCHERS ---
                // Combine BP values into tempValue
                watch([bpSys, bpDia], ([sys, dia]) => {
                    if (sys && dia) {
                        tempValue.value = `${sys}/${dia}`;
                    }
                });

                // --- AUTH / SESSION LOGIC ---
                const lookupSessions = async () => {
                    if (!userNameInput.value.trim()) return;

                    // Fetch sessions for this name
                    const sessions = await db.sessions.where('user_name').equals(userNameInput.value).toArray();
                    availableSessions.value = sessions;
                    authStep.value = 'session';
                    selectedSessionId.value = null; // Default to new
                };

                const handleSessionStart = async () => {
                    let sessId = selectedSessionId.value;

                    if (!sessId) {
                        // Create NEW session
                        sessId = await db.sessions.add({
                            user_name: userNameInput.value,
                            created_at: new Date().toISOString()
                        });
                    }

                    // Log in
                    currentSessionId.value = sessId;
                    isAuthenticated.value = true;

                    // Persist session
                    localStorage.setItem(SESSION_KEY, Date.now() + SESSION_DURATION);
                    localStorage.setItem(SESSION_ID_KEY, sessId);

                    loadDailyProgress();
                };

                const logout = () => {
                    isAuthenticated.value = false;
                    userNameInput.value = '';
                    authStep.value = 'name';
                    localStorage.removeItem(SESSION_KEY);
                    localStorage.removeItem(SESSION_ID_KEY);
                    currentSessionId.value = null;
                };

                const checkSession = async () => {
                    const expiry = localStorage.getItem(SESSION_KEY);
                    const sessId = parseInt(localStorage.getItem(SESSION_ID_KEY));

                    if (expiry && parseInt(expiry) > Date.now() && sessId) {
                        try {
                            const session = await db.sessions.get(sessId);
                            if (session) {
                                currentSessionId.value = sessId;
                                userNameInput.value = session.user_name; // Restore name
                                isAuthenticated.value = true;
                                loadDailyProgress();
                                return;
                            }
                        } catch (e) {
                            console.error("Invalid session", e);
                        }
                    }

                    // Fallback to logged out
                    isAuthenticated.value = false;
                };

                const dangerClearAll = async () => {
                    if (confirm("ARE YOU SURE? This will permanently delete ALL data for ALL users. This cannot be undone.")) {
                        await db.delete();
                        window.location.reload();
                    }
                };

                // --- PROGRESS LOGIC (PIE CHARTS) ---
                const loadDailyProgress = async () => {
                    if (!currentSessionId.value) return;

                    // Filter by session_id, date, AND report_id (if set)
                    // If currentReportId is null, we can't show specific progress, but typically it should be set when in Step 2.
                    // For legacy support (entries with no report_id), we might need careful handling, but relying on report_id for new flow.

                    let collection = db.entries
                        .where('effective_date').equals(effectiveDate.value)
                        .and(entry => entry.session_id === currentSessionId.value);

                    // If we have a specific report ID (AM/PM/Acute), filter by it. 
                    if (currentReportId.value) {
                        collection = collection.and(entry => entry.report_id === currentReportId.value);
                    }

                    const todayEntries = await collection.toArray();

                    const counts = {};
                    const keys = new Set();

                    todayEntries.forEach(entry => {
                        keys.add(entry.key);
                        const parts = entry.key.split('_');
                        if (parts.length > 1) {
                            const catId = parts[0];
                            if (!counts[catId]) counts[catId] = new Set();
                            counts[catId].add(entry.key);
                        }
                    });

                    const finalCounts = {};
                    for (const cat in counts) {
                        finalCounts[cat] = counts[cat].size;
                    }
                    dailyCounts.value = finalCounts;
                    answeredKeys.value = keys;
                };

                const getCategoryCount = (catId) => {
                    return dailyCounts.value[catId] || 0;
                };

                const getPieProgress = (catId) => {
                    const answered = dailyCounts.value[catId] || 0;
                    const total = schema.value.find(c => c.id === catId)?.questions.length || 1;
                    return Math.min((answered / total) * 100, 100);
                };

                const getPieColorClass = (catId) => {
                    const pct = getPieProgress(catId);
                    if (pct <= 30) return 'text-red-500';
                    if (pct <= 70) return 'text-yellow-500';
                    return 'text-green-500';
                };

                // --- FLOW LOGIC ---
                const selectContext = (ctx) => {
                    selectedContext.value = ctx;
                    currentStep.value = 2;

                    if (ctx === 'AM' || ctx === 'PM') {
                        // Singleton per day
                        currentReportId.value = `${effectiveDate.value}_${ctx}`;
                        acuteFullSurvey.value = false; // reset
                    } else if (ctx === 'Acute') {
                        // Unique per launch!
                        currentReportId.value = `${effectiveDate.value}_ACUTE_${Date.now()}`;
                        acuteFullSurvey.value = false; // Default off
                    } else {
                        // Doctor/Research
                        currentReportId.value = `${effectiveDate.value}_${ctx}`;
                    }

                    loadDailyProgress();
                    if (ctx === 'Doctor' || ctx === 'Research') {
                        contextNote.value = '';
                    }
                    showPeriodic.value = false;
                };

                const resetToStart = () => {
                    currentStep.value = 1;
                    selectedContext.value = '';
                    contextNote.value = '';
                };

                // --- WIZARD LOGIC ---
                const enterCategory = (category) => {
                    activeCategory.value = category;

                    // If Acute and NOT Full Survey -> FORCE Quick Mode
                    if (selectedContext.value === 'Acute' && !acuteFullSurvey.value) {
                        activeQuestionIndex.value = 0;
                        returnAfterOne.value = true;
                        setupQuestionState();
                        currentStep.value = 3;
                        return;
                    }

                    // Gap Filling Logic (AM/PM or Full Acute)
                    const firstUnansweredIdx = category.questions.findIndex(q => !answeredKeys.value.has(`${category.id}_${q.id}`));
                    const answeredCount = dailyCounts.value[category.id] || 0;

                    if (firstUnansweredIdx !== -1) {
                        activeQuestionIndex.value = firstUnansweredIdx;
                        // GAP FILL: If started, jump to gap and return.
                        if (answeredCount > 0) {
                            returnAfterOne.value = true;
                        } else {
                            returnAfterOne.value = false;
                        }
                    } else {
                        // All answered (Review mode)
                        activeQuestionIndex.value = 0;
                        returnAfterOne.value = false;
                    }

                    setupQuestionState();
                    currentStep.value = 3;
                };

                const setupQuestionState = () => {
                    tempValue.value = '';
                    tempNote.value = '';
                    showNoteField.value = false;
                    bpSys.value = '';
                    bpDia.value = '';
                    selectedTags.value = []; // Reset checkboxes

                    // Initialize Likert with 0 so it's a valid answer immediately
                    if (activeQuestion.value.input.type === 'likert') {
                        tempValue.value = 0;
                    }
                };

                // Spinner Logic
                const adjustValue = (delta) => {
                    let val = parseInt(tempValue.value);
                    if (isNaN(val)) val = 0;
                    val += delta;
                    if (val < 0) val = 0;
                    if (val > activeQuestion.value.input.max) val = activeQuestion.value.input.max;
                    tempValue.value = val;
                };

                const handleWheel = (e) => {
                    if (e.deltaY < 0) adjustValue(1);
                    else adjustValue(-1);
                };

                let touchStartY = 0;
                const handleTouchStart = (e) => { touchStartY = e.touches[0].clientY; };
                const handleTouchMove = (e) => {
                    const touchY = e.touches[0].clientY;
                    const diff = touchStartY - touchY;
                    if (Math.abs(diff) > 20) { // Threshold
                        adjustValue(diff > 0 ? 1 : -1);
                        touchStartY = touchY; // Reset for continuous drag
                    }
                };

                const toggleTag = (tag) => {
                    if (selectedTags.value.includes(tag)) {
                        selectedTags.value = selectedTags.value.filter(t => t !== tag);
                    } else {
                        selectedTags.value.push(tag);
                    }
                };

                const skipQuestion = () => {
                    if (isLastQuestion.value) {
                        finishCategory();
                    } else {
                        activeQuestionIndex.value++;
                        setupQuestionState();
                    }
                };

                const nextQuestion = async () => {
                    // MERGE TAGS INTO NOTE
                    let finalNote = tempNote.value;
                    if (selectedTags.value.length > 0) {
                        const tagsStr = `[${selectedTags.value.join(', ')}]`;
                        finalNote = finalNote ? `${tagsStr} ${finalNote}` : tagsStr;
                    }

                    await saveEntry(activeCategory.value.id, activeQuestion.value.id, tempValue.value, finalNote);

                    if (returnAfterOne.value) {
                        loadDailyProgress();
                        currentStep.value = 2; // Return to categories
                        return;
                    }

                    if (isLastQuestion.value) {
                        finishCategory();
                    } else {
                        activeQuestionIndex.value++;
                        setupQuestionState();
                    }
                };

                const finishCategory = () => {
                    loadDailyProgress();
                    const currentIdx = visibleCategories.value.findIndex(c => c.id === activeCategory.value.id);
                    if (currentIdx < visibleCategories.value.length - 1) {
                        const nextCat = visibleCategories.value[currentIdx + 1];
                        enterCategory(nextCat);
                    } else {
                        alert("All categories in this section complete!");
                        currentStep.value = 2;
                    }
                };

                const prevQuestion = () => {
                    if (activeQuestionIndex.value > 0) {
                        activeQuestionIndex.value--;
                        setupQuestionState();
                    } else {
                        currentStep.value = 2;
                    }
                };

                // --- DATA SAVING ---
                const saveEntry = async (catId, qId, val, note) => {
                    const entry = {
                        session_id: currentSessionId.value,
                        report_id: currentReportId.value,
                        timestamp: new Date().toISOString(),
                        effective_date: effectiveDate.value,
                        context: selectedContext.value,
                        key: `${catId}_${qId}`,
                        val: val,
                        note: note
                    };
                    await db.entries.add(entry);
                };

                const saveContextNote = async () => {
                    // if (!contextNote.value) return; // Allow empty notes
                    await saveEntry(selectedContext.value.toLowerCase(), 'general_note', 'See Note', contextNote.value || '');
                    alert("Note saved!");
                    resetToStart();
                };

                // --- HISTORY & EXPORT ---
                const showHistory = async () => {
                    showingHistory.value = true;
                    const all = await db.entries.orderBy('timestamp').reverse().toArray();
                    const sessionEntries = all.filter(e => e.session_id === currentSessionId.value).slice(0, 20);
                    recentHistory.value = sessionEntries;
                };

                const getLabelFromId = (key) => key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                // --- EXPORT UTILS ---
                const exportCSV = async () => {
                    let data = await db.entries.toArray();
                    // Filter by Session ID
                    data = data.filter(d => d.session_id === currentSessionId.value);

                    if (exportStart.value) data = data.filter(d => d.effective_date >= exportStart.value);
                    if (exportEnd.value) data = data.filter(d => d.effective_date <= exportEnd.value);

                    let csv = "Timestamp,Date,Context,ReportID,Key,Value,Note\n";
                    data.forEach(d => {
                        csv += `"${d.timestamp}","${d.effective_date}","${d.context}","${d.report_id || ''}","${d.key}","${d.val}","${(d.note || '').replace(/"/g, '""')}"\n`;
                    });

                    const filename = `SymptomTracker_Export_${new Date().toISOString().split('T')[0]}.csv`;
                    downloadFile(csv, filename, "text/csv");
                };

                const exportMarkdown = async () => {
                    let data = await db.entries.toArray();
                    // Filter by Session ID
                    data = data.filter(d => d.session_id === currentSessionId.value);

                    if (exportStart.value) data = data.filter(d => d.effective_date >= exportStart.value);
                    if (exportEnd.value) data = data.filter(d => d.effective_date <= exportEnd.value);

                    let md = "# Export\n\n";
                    data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    data.forEach(d => {
                        md += `## ${d.effective_date} (${d.context})\n* **${getLabelFromId(d.key)}**: ${d.val}\n${d.note ? '> ' + d.note + '\n' : ''}\n`;
                    });
                    downloadFile(md, "tracker_export.md", "text/markdown");
                };

                const downloadFile = (content, fileName, mimeType) => {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };

                const syncToDrive = async () => {
                    alert("Syncing logic is preserved from previous version (simplified for this view)");
                };

                onMounted(() => {
                    checkSession();
                    const loader = document.getElementById('loading-screen');
                    if (loader) loader.style.display = 'none';
                });

                return {
                    isAuthenticated, pinInput: ref(''),
                    currentStep, effectiveDate, selectedContext, contextNote,
                    selectContext, enterCategory, resetToStart,
                    schema, activeCategory, activeQuestion, activeQuestionIndex, isLastQuestion, progressPercent,
                    tempValue, tempNote, showNoteField, nextQuestion, prevQuestion, skipQuestion,
                    saveContextNote, showHistory, showingHistory, recentHistory, exportCSV, exportMarkdown,
                    exportStart, exportEnd, getLabelFromId,
                    showPeriodic, visibleCategories,
                    getPieProgress, getCategoryCount, getPieColorClass,
                    handleWheel, handleTouchStart, handleTouchMove, adjustValue,
                    bpSys, bpDia,

                    // Pain specific
                    MANKOSKI_SCALE, selectedTags, toggleTag,

                    // New Session Auth Props
                    authStep, userNameInput, availableSessions, selectedSessionId, lookupSessions, handleSessionStart, dangerClearAll,
                    logout, checkSession, syncToDrive,

                    // Acute Props
                    acuteFullSurvey
                };
            }
        }).mount('#app');
    </script>
</body>

</html>